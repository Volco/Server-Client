#!/usr/bin/env node

'use strict';

const fs = require("fs");
const path = require("path");
process.chdir(path.resolve(__dirname, '..'));
const imageSize = require('image-size');

// Make sure this is true when committing
const isVPS = true;;

const vpsDawnPath = '/home/dawn/Dawn/';
const localDawnPath = '../data/Dawn/';

const dawnPath = isVPS ? vpsDawnPath : localDawnPath;

const Dex = require(dawnPath + '.sim-dist/dex').Dex;
const toID = Dex.toID;

process.stdout.write("Updating animated sprite dimensions... ");

let buf = `/*
DO NOT EDIT

THIS FILE IS AUTOGENERATED BY ./build-tools/build-digidex
*/

exports.BattleDigimonSprites = {
	substitute:{exists:false, front:{w:34, h:39}, back:{w:37, h:38}},
`;


let g5buf = `/*
DO NOT EDIT

THIS FILE IS AUTOGENERATED BY ./build-tools/build-minidex
*/

exports.BattleDigimonSpritesBW = {
`;

function sizeObj(path) {
	try {
		let size = imageSize(path);
		return {
			w: size.width,
			h: size.height,
		};
	} catch (e) {}
}

function updateSizes() {
	for (let baseid in Dex.mod('digimon').data.Pokedex) {
		let species = Dex.species.get(baseid);
		if (!species.exists) {
			for (let formeName of [''].concat(species.cosmeticFormes || [])) {
				let spriteid = species.id;
				if (formeName) spriteid += '-' + toID(formeName).slice(species.id.length);
				let id = toID(spriteid);

				let row = {
					num: species.num,
				};
				const frontSize = sizeObj('sprites/custom/' + species.id + '.png');
				if (frontSize) row.front = frontSize;
				const frontSizeF = sizeObj('sprites/custom/' + spriteid + '-f.png');
				if (frontSizeF) row.frontf = frontSizeF;
				const backSize = sizeObj('sprites/custom-back/' + spriteid + '.png');
				if (backSize) row.back = backSize;
				const backSizeF = sizeObj('sprites/custom-back/' + spriteid + '-f.png');
				if (backSizeF) row.backf = backSizeF;
				if (row.front || row.back || !row.forme) {
					buf += `\t${id}:` + JSON.stringify(row).replace(/"/g, '') + `,\n`;
				}
			}
		}
	}

	buf = buf.slice(0, -2) + `
};
`;

	fs.writeFileSync('data/digidex-mini.js', buf);
}

if (fs.existsSync('sprites/')) {
	updateSizes();
	console.log('DONE');
} else {
	console.log('SKIPPED');
}
